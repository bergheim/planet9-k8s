---
apiVersion: app.k8s.io/v1beta1
kind: Application
metadata:
  name: "$APP_INSTANCE_NAME"
  annotations:
    kubernetes-engine.cloud.google.com/icon: >-
      data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAABIAAAASABGyWs+AAAACXZwQWcAAAAQAAAAEABcxq3DAAABuklEQVQ4y6XTv0vVURgG8M/5er16Na8QQQg5iFFgQ2AUUghCNIQQVEPgbA1NLf1caqvoT8i2KFqCAmkNoihcGvo1FBJmIVnU9eb9qt+vp8GU64Vw8N3O4Xme87zv+5zw/c5eDdWDMziCXjRhEk9xG2/qwaFB4AbOI/H/GsPp1UM98CEubkCGUTxvFLiO4+usCQLytCKrzsmqc+JSVQgBDuLeagtd+LqenIj5gjxNtfUMKHbtI2bmP4xb+DGtudwhxgj9CS40eowxk6ep8oFRbX0nZZUZea2qPHRV+67DsmpFWDF/rYDhRoG8Nm/LnmOKXf1mH50V8yDmQenbhPLgFUuz7+W1GaFQ2p+gu+F5YlTcMaD27oG4HDSXy4pbO9SmPko/PdHaM2h5IYPOjSa+YSWYWncTAiFY/PJSqe+UkERLlYrFn3NK3Tu19h6VTj6TtBTgdwHjOFev0VRqU337WNK+3bbhW9LPr4RCi5aeIX9e37X0a1qhvVO0PLHpNa5G+TouNQaJKEsrYhZWnLUESXGNfB8jhX/4y9hdn8YorpBayw1LivACI/VRhhO4ieUNBj+GQ2tON/ud/wLyf7KfZi4CEAAAACV0RVh0Y3JlYXRlLWRhdGUAMjAxMy0xMC0xOFQxMzo1ODo1NCswMDowME8CzXkAAAAldEVYdG1vZGlmeS1kYXRlADIwMTMtMTAtMThUMTM6NTg6NTQrMDA6MDAQs7tNAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAABJRU5ErkJgggAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==
    marketplace.cloud.google.com/deploy-info: '{partner_id: "neptune-software", product_id: "planet9", partner_name: "Neptune Software"}'
  labels:
    app.kubernetes.io/name: "$APP_INSTANCE_NAME"
spec:
  descriptor:
    type: Planet9
    version: '1.0.6'
    description: |-
      Low-code, rapid application development software that unifies the end-user experience and app development to integrate with any cloud, any backend and any architecture across mobile, desktop and offline environments.
    links:
    - description: 'User Guide: Planet9 TODO add link to github repo'
      url: https://github.com/bergheim/planet9-k8s
    notes: |-
      # Expose the Planet9 service

      ## Using the command line

      By default, the service does not have an external IP. Make sure you have
      [kubectl
      installed](https://kubernetes.io/docs/tasks/tools/install-kubectl/), and
      run the following command to expose an external IP:

      ```
      kubectl patch service/"$APP_INSTANCE_NAME-planet9-service" \
        --namespace "$NAMESPACE" \
        --patch '{"spec": {"type": "LoadBalancer"}}'
      ```

      Alternatively, you can forward the port to your local machine:
      use `kubectl port-forward` and access the UI from your local machine.

      Run the following command:

      ```
      kubectl port-forward -n $NAMESPACE \
        svc/$APP_INSTANCE_NAME-planet9-service 8080
      ```

      Open Planet9 in your web browser with `http://localhost:8080/`.

      ## Using the Google Console

      1. On your project, navigate to `Kubernetes Engine` -> `Services`
      2. Click on the installed service
      3. Scroll down to the bottom, click `Port forwarding`
      4. Click `Run in Cloud Shell`, enable it if you got the question, and
      then execute the command (hit enter)
      5. To the right on the bar over the shell, click the `Web preview` icon
      and then `Preview on port 8080` (alternatively there should now be a
      button to the right of `Port forwarding` which says `Open in web preview`

      # Access Planet9

      Get the external IP of the Planet9 service:
      ```
      SERVICE_IP=$(kubectl get service/$APP_INSTANCE_NAME-planet9-service \
        --namespace $NAMESPACE \
        --output jsonpath='{.status.loadBalancer.ingress[0].ip}')

      echo "http://${SERVICE_IP}"
      ```

      Note that it might take some time for the external IP to be provisioned.

      # Scale the cluster

      To scale the cluster, use either a GKE UI (use the Scale option in the
      StatefulSet details screen) or the following command:

      ```
      kubectl scale "$APP_INSTANCE_NAME-planet9" \
        --namespace "$NAMESPACE" --replicas=<new-replicas>
      ```

      By default, there are 1 replica. To increase performance, you can increase
      this number.

      # Setting up SSL

      By default, Planet9 does not expose its IP externally. This is because a
      certificate is needed to set up a proper HTTPS connection.

      To set this up, you would first start Planet9 normally, then forward the
      port to your local machine (or use the web interface) as described above.
      You can now log in to Planet9, and set up the certificates in Planet9 as
      described TODO HERE.

      Once this is done, remove the HTTP port and add the HTTPS port:

      ```
      kubectl patch service/"$APP_INSTANCE_NAME-planet9-service" \
        --namespace "$NAMESPACE" \
        --patch '{"spec": {"ports": [{"name": "https","port
        ": 443, "targetPort": 8081}]}'
      ```
    info:
    - name: Forward Planet9 port locally
      value: kubectl port-forward --namespace ${NAMESPACE} ${APP_INSTANCE_NAME}-planet9-0 8080
    - name: Planet9 UI URL
      value: http://localhost:8080/
    - name: Administrator username
      value: admin
    - name: Administrator password
      type: Reference
      valueFrom:
        type: SecretKeyRef
        secretKeyRef:
          name: $APP_INSTANCE_NAME-secret
          key: adminPassword
  selector:
    matchLabels:
      app.kubernetes.io/name: "$APP_INSTANCE_NAME"
  componentKinds:
  - group: apps/v1beta2
    kind: Deployment
  - group: v1
    kind: Service
  - group: apps/v1beta2
    kind: StatefulSet
  - group: v1
    kind: Secret
  - group: batch/v1
    kind: Job
